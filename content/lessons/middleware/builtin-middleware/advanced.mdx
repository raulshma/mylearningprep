# Built-in Middleware: Advanced Configuration

Beyond basic usage, ASP.NET Core's built-in middleware offers extensive customization for enterprise-grade applications.

## Section 1: Built-in Overview - Response Compression

<BuiltInMiddlewareExplorer mode="advanced" />

### Response Compression

```csharp
builder.Services.AddResponseCompression(options =>
{
    options.EnableForHttps = true;
    options.Providers.Add<BrotliCompressionProvider>();
    options.Providers.Add<GzipCompressionProvider>();
    options.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat(
        new[] { "image/svg+xml", "application/json" });
});

builder.Services.Configure<BrotliCompressionProviderOptions>(options =>
{
    options.Level = CompressionLevel.Optimal;
});

// Place BEFORE UseStaticFiles
app.UseResponseCompression();
```

### Response Caching

```csharp
builder.Services.AddResponseCaching(options =>
{
    options.MaximumBodySize = 1024 * 1024;
    options.SizeLimit = 100 * 1024 * 1024;
});

app.UseResponseCaching();

// Apply to endpoints
[ResponseCache(Duration = 60, VaryByHeader = "Accept-Encoding")]
public IActionResult GetProducts() { }
```

<ProgressCheckpoint section="builtin-overview" xpReward={21} />

---

## Section 2: Security Middleware - Rate Limiting

### Rate Limiting (.NET 7+)

```csharp
builder.Services.AddRateLimiter(options =>
{
    options.AddFixedWindowLimiter("fixed", limiterOptions =>
    {
        limiterOptions.PermitLimit = 100;
        limiterOptions.Window = TimeSpan.FromMinutes(1);
        limiterOptions.QueueLimit = 10;
    });
    
    options.AddSlidingWindowLimiter("sliding", limiterOptions =>
    {
        limiterOptions.PermitLimit = 100;
        limiterOptions.Window = TimeSpan.FromMinutes(1);
        limiterOptions.SegmentsPerWindow = 6;
    });
    
    options.OnRejected = async (context, token) =>
    {
        context.HttpContext.Response.StatusCode = 429;
        await context.HttpContext.Response.WriteAsJsonAsync(new
        {
            error = "Too many requests"
        }, token);
    };
});

app.UseRateLimiter();

app.MapGet("/api/search", SearchHandler)
   .RequireRateLimiting("sliding");
```

### Output Caching (.NET 7+)

```csharp
builder.Services.AddOutputCache(options =>
{
    options.AddPolicy("Products", builder =>
        builder.Tag("products")
               .Expire(TimeSpan.FromHours(1)));
});

app.UseOutputCache();

app.MapGet("/api/products", GetProducts)
   .CacheOutput("Products");

// Invalidate by tag
app.MapPost("/api/products", async (IOutputCacheStore cache, Product product) =>
{
    await SaveProduct(product);
    await cache.EvictByTagAsync("products", default);
    return Results.Created($"/api/products/{product.Id}", product);
});
```

<ProgressCheckpoint section="security-middleware" xpReward={22} />

---

## Section 3: Performance Middleware - Health Checks

### Health Checks

```csharp
builder.Services.AddHealthChecks()
    .AddCheck("self", () => HealthCheckResult.Healthy())
    .AddSqlServer(builder.Configuration.GetConnectionString("Default")!)
    .AddRedis(builder.Configuration.GetConnectionString("Redis")!);

app.MapHealthChecks("/health/ready", new HealthCheckOptions
{
    Predicate = check => check.Tags.Contains("ready")
});

app.MapHealthChecks("/health/live", new HealthCheckOptions
{
    Predicate = _ => false
});
```

### URL Rewriting

```csharp
var rewriteOptions = new RewriteOptions()
    .AddRedirect("old-path/(.*)", "new-path/$1", 301)
    .AddRedirectToHttpsPermanent()
    .AddRewrite(@"^api/v1/(.*)", "api/v2/$1", skipRemainingRules: true);

app.UseRewriter(rewriteOptions);
```

### Request Localization

```csharp
builder.Services.Configure<RequestLocalizationOptions>(options =>
{
    var supportedCultures = new[] { "en-US", "es-ES", "fr-FR" }
        .Select(c => new CultureInfo(c)).ToArray();
    
    options.DefaultRequestCulture = new RequestCulture("en-US");
    options.SupportedCultures = supportedCultures;
    options.SupportedUICultures = supportedCultures;
});

app.UseRequestLocalization();
```

### Key Takeaways

| Middleware | Purpose |
| :--------- | :------ |
| **Compression** | Reduce bandwidth (Brotli > Gzip) |
| **Rate Limiting** | Protect from abuse |
| **Output Caching** | Server-side caching with tags |
| **Health Checks** | Monitor app health |
| **URL Rewriting** | Redirects and path manipulation |

<ProgressCheckpoint section="performance-middleware" xpReward={22} />
