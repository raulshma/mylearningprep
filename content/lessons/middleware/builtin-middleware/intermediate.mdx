# Built-in Middleware: Comprehensive Guide

ASP.NET Core includes a rich set of middleware components that handle common web application requirements.

## Section 1: Built-in Overview

<BuiltInMiddlewareExplorer mode="intermediate" />

### Exception Handling

Configure how errors are displayed based on environment:

```csharp
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage();
}
else
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}
```

<InfoBox type="warning">
  **Never** use `UseDeveloperExceptionPage()` in production!
</InfoBox>

### Static Files Configuration

```csharp
// Serve from wwwroot
app.UseStaticFiles();

// Custom folder
app.UseStaticFiles(new StaticFileOptions
{
    FileProvider = new PhysicalFileProvider(
        Path.Combine(builder.Environment.ContentRootPath, "MyFiles")),
    RequestPath = "/files"
});
```

<ProgressCheckpoint section="builtin-overview" xpReward={15} />

---

## Section 2: Security Middleware

### HTTPS and HSTS

```csharp
if (!app.Environment.IsDevelopment())
{
    app.UseHsts();
}
app.UseHttpsRedirection();
```

### CORS Configuration

```csharp
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowMyFrontend", policy =>
    {
        policy.WithOrigins("https://myapp.com")
              .AllowAnyHeader()
              .AllowAnyMethod()
              .AllowCredentials();
    });
});

app.UseCors("AllowMyFrontend");
```

### Authentication & Authorization

```csharp
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = "https://auth.myapp.com";
        options.Audience = "myapi";
    });

builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy =>
        policy.RequireRole("Admin"));
});

app.UseAuthentication();
app.UseAuthorization();
```

<ProgressCheckpoint section="security-middleware" xpReward={15} />

---

## Section 3: Performance Middleware

### Session Middleware

```csharp
builder.Services.AddDistributedMemoryCache();
builder.Services.AddSession(options =>
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);
    options.Cookie.HttpOnly = true;
    options.Cookie.IsEssential = true;
});

app.UseSession();
```

### The Recommended Pipeline Order

```csharp
var app = builder.Build();

app.UseExceptionHandler("/Error");
app.UseHsts();
app.UseHttpsRedirection();
app.UseStaticFiles();
app.UseRouting();
app.UseCors();
app.UseAuthentication();
app.UseAuthorization();
app.UseSession();
app.MapControllers();
```

### Key Takeaways

| Middleware | Purpose |
| :--------- | :------ |
| Exception Handler | Catch and display errors |
| HTTPS/HSTS | Force secure connections |
| CORS | Cross-origin requests |
| Auth | Identity and permissions |
| Session | Server-side state |

<ProgressCheckpoint section="performance-middleware" xpReward={15} />
