# Advanced Minimal APIs Patterns

Leverage Minimal APIs for sophisticated scenarios including OpenAPI, testing, and enterprise patterns.

## Section 1: TypedResults and OpenAPI

<MinimalApiBuilder mode="advanced" />

### TypedResults for Better Documentation

```csharp
app.MapGet("/products/{id}", 
    Results<Ok<Product>, NotFound> (int id, IProductService service) =>
{
    var product = service.GetById(id);
    return product is not null
        ? TypedResults.Ok(product)
        : TypedResults.NotFound();
})
.WithName("GetProductById")
.WithOpenApi(op =>
{
    op.Summary = "Get a product by ID";
    op.Description = "Returns a single product";
    return op;
});
```

### OpenAPI Configuration

```csharp
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

var products = app.MapGroup("/api/products")
    .WithTags("Products")
    .WithOpenApi();

products.MapGet("/", GetAll)
    .Produces<List<Product>>(200)
    .ProducesProblem(500);

products.MapPost("/", Create)
    .Accepts<CreateProductRequest>("application/json")
    .Produces<Product>(201)
    .ProducesValidationProblem();
```

<ProgressCheckpoint section="minimal-apis-intro" xpReward={16} />

---

## Section 2: Endpoint Extensions and Parameter Objects

### Reusable Endpoint Extensions

```csharp
public static class ProductEndpoints
{
    public static RouteGroupBuilder MapProductEndpoints(
        this IEndpointRouteBuilder routes)
    {
        var group = routes.MapGroup("/api/products")
            .WithTags("Products")
            .RequireAuthorization();

        group.MapGet("/", GetAll);
        group.MapGet("/{id}", GetById);
        group.MapPost("/", Create).AllowAnonymous();
        group.MapPut("/{id}", Update);
        group.MapDelete("/{id}", Delete)
            .RequireAuthorization("AdminOnly");

        return group;
    }

    private static async Task<IResult> GetAll(
        IProductService service,
        [AsParameters] ProductQueryParams query)
    {
        var products = await service.SearchAsync(query);
        return TypedResults.Ok(products);
    }
}

// Usage in Program.cs
app.MapProductEndpoints();
```

### Parameter Objects with [AsParameters]

```csharp
public class ProductQueryParams
{
    [FromQuery] public string? Category { get; set; }
    [FromQuery] public decimal? MinPrice { get; set; }
    [FromQuery] public decimal? MaxPrice { get; set; }
    [FromQuery] public int Page { get; set; } = 1;
    [FromQuery] public int PageSize { get; set; } = 10;
}

app.MapGet("/products", (
    [AsParameters] ProductQueryParams query,
    IProductService service) => service.Search(query));
```

<ProgressCheckpoint section="minimal-apis-intermediate" xpReward={16} />

---

## Section 3: Testing and Deployment

### Testing with WebApplicationFactory

```csharp
public class ProductApiTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;

    public ProductApiTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }

    [Fact]
    public async Task GetProducts_ReturnsOk()
    {
        var response = await _client.GetAsync("/api/products");

        response.EnsureSuccessStatusCode();
        var products = await response.Content
            .ReadFromJsonAsync<List<Product>>();
        Assert.NotNull(products);
    }

    [Fact]
    public async Task CreateProduct_WithValidData_ReturnsCreated()
    {
        var product = new { Name = "Test", Price = 9.99 };

        var response = await _client.PostAsJsonAsync("/api/products", product);

        Assert.Equal(HttpStatusCode.Created, response.StatusCode);
    }
}
```

### Docker Deployment

```dockerfile
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet publish -c Release -o /app

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app .
EXPOSE 8080
ENTRYPOINT ["dotnet", "ProductApi.dll"]
```

```csharp
// Container-friendly configuration
var builder = WebApplication.CreateSlimBuilder(args);
builder.WebHost.UseUrls("http://+:8080");
```

### Best Practices Summary

| Pattern | Use Case |
| :------ | :------- |
| **Route Groups** | Organize related endpoints |
| **TypedResults** | Better OpenAPI documentation |
| **[AsParameters]** | Complex query parameters |
| **Endpoint Extensions** | Reusable endpoint modules |
| **Filters** | Cross-cutting concerns |

<ProgressCheckpoint section="minimal-apis-advanced" xpReward={18} />
