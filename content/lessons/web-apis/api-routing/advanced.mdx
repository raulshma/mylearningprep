# Advanced Routing Patterns

Master sophisticated routing techniques for complex API architectures.

## Section 1: Custom Route Constraints

<RoutingAttributeExplorer mode="advanced" />

### Creating Custom Constraints

Create reusable constraints for domain-specific validation:

```csharp
public class ProductCodeConstraint : IRouteConstraint
{
    public bool Match(
        HttpContext? httpContext,
        IRouter? route,
        string routeKey,
        RouteValueDictionary values,
        RouteDirection routeDirection)
    {
        if (values.TryGetValue(routeKey, out var value))
        {
            var code = value?.ToString();
            return code != null &&
                   code.Length == 8 &&
                   code.StartsWith("PRD-");
        }
        return false;
    }
}

// Register in Program.cs
builder.Services.Configure<RouteOptions>(options =>
{
    options.ConstraintMap.Add("productCode", typeof(ProductCodeConstraint));
});

// Usage
[HttpGet("{code:productCode}")]
public ActionResult<Product> GetByCode(string code) { }
```

### Composite Constraints

```csharp
// Multiple constraints on one parameter
[HttpGet("{id:int:min(1):max(10000)}")]
public ActionResult<Product> GetById(int id) { }

// Custom constraint with built-in
[HttpGet("{code:productCode:required}")]
public ActionResult<Product> GetByCode(string code) { }
```

<ProgressCheckpoint section="routing-intro" xpReward={16} />

---

## Section 2: Endpoint Metadata and Areas

### Custom Endpoint Metadata


```csharp
[AttributeUsage(AttributeTargets.Method)]
public class RequiresPremiumAttribute : Attribute
{
    public string Plan { get; set; } = "Premium";
}

// Usage on action
[HttpGet("premium-features")]
[RequiresPremium(Plan = "Enterprise")]
public ActionResult GetPremiumFeatures() { }

// Access in middleware
app.Use(async (context, next) =>
{
    var endpoint = context.GetEndpoint();
    var requiresPremium = endpoint?.Metadata
        .GetMetadata<RequiresPremiumAttribute>();

    if (requiresPremium != null)
    {
        // Check user's subscription plan
    }

    await next();
});
```

### Area Routing

Organize large APIs into areas:

```csharp
// Areas/Admin/Controllers/UsersController.cs
[Area("Admin")]
[Route("api/[area]/[controller]")]
public class UsersController : ControllerBase
{
    // Route: /api/admin/users
    [HttpGet]
    public ActionResult<List<User>> GetAll() { }
}
```

<ProgressCheckpoint section="routing-intermediate" xpReward={16} />

---

## Section 3: Route Precedence and Link Generation

### Route Matching Priority

```csharp
// More specific routes match first

// 1. Literal segments match first
[HttpGet("featured")]  // /api/products/featured

// 2. Then constrained parameters
[HttpGet("{id:int}")]  // /api/products/42

// 3. Then unconstrained parameters
[HttpGet("{slug}")]    // /api/products/laptop-pro

// 4. Finally catch-all
[HttpGet("{**path}")]  // /api/products/any/nested/path
```

### Link Generation

```csharp
public class ProductsController : ControllerBase
{
    private readonly LinkGenerator _linkGenerator;

    public ProductsController(LinkGenerator linkGenerator)
        => _linkGenerator = linkGenerator;

    [HttpPost]
    public ActionResult Create(Product product)
    {
        _service.Add(product);

        var url = _linkGenerator.GetPathByAction(
            action: nameof(GetById),
            controller: "Products",
            values: new { id = product.Id });

        return Created(url!, product);
    }

    [HttpGet("{id}", Name = "GetProductById")]
    public ActionResult<Product> GetById(int id) { }
}
```

### Route Debugging

```csharp
// Debug endpoint to inspect all routes
app.MapGet("/debug/routes", (IEnumerable<EndpointDataSource> sources) =>
{
    var endpoints = sources
        .SelectMany(s => s.Endpoints)
        .OfType<RouteEndpoint>()
        .Select(e => new
        {
            Route = e.RoutePattern.RawText,
            Methods = e.Metadata.GetMetadata<HttpMethodMetadata>()?.HttpMethods,
            DisplayName = e.DisplayName
        });

    return Results.Ok(endpoints);
});
```

### Best Practices Summary

| Pattern | Use Case |
| :------ | :------- |
| **Custom Constraints** | Domain-specific validation |
| **Endpoint Metadata** | Cross-cutting concerns |
| **Areas** | Large API organization |
| **Named Routes** | Link generation |
| **Catch-all Routes** | Fallback handling |

<ProgressCheckpoint section="routing-advanced" xpReward={18} />
